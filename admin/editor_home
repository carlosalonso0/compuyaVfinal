<?php
// Incluir autenticación
require_once 'includes/auth.php';

// Título de la página
$page_title = 'Editor de Página Principal';

// Incluir encabezado
include 'includes/header.php';

// Cargar configuración actual
$query = "SELECT * FROM configuracion_home";
$stmt = $db->prepare($query);
$stmt->execute();
$configuraciones = [];
while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $configuraciones[$row['clave']] = $row['valor'];
}

// Cargar sliders
$query = "SELECT * FROM home_sliders WHERE activo = true ORDER BY orden ASC";
$stmt = $db->prepare($query);
$stmt->execute();
$sliders = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Cargar banners
$query = "SELECT * FROM home_banners WHERE activo = true ORDER BY orden ASC";
$stmt = $db->prepare($query);
$stmt->execute();
$banners = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Cargar productos destacados
$query = "SELECT p.*, c.nombre as categoria_nombre 
          FROM productos p
          LEFT JOIN categorias c ON p.categoria_id = c.id
          WHERE p.destacado = true AND p.activo = true
          ORDER BY p.id DESC LIMIT 8";
$stmt = $db->prepare($query);
$stmt->execute();
$productos_destacados = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Cargar categorías
$query = "SELECT * FROM categorias WHERE activo = true ORDER BY nombre ASC";
$stmt = $db->prepare($query);
$stmt->execute();
$categorias = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Obtener la lista de categorías destacadas
$categorias_destacadas_ids = isset($configuraciones['categorias_destacadas']) ? 
                           explode(',', $configuraciones['categorias_destacadas']) : [];

// Procesar cambios en la configuración
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    $action = $_POST['action'];
    
    if ($action === 'save_config') {
        // Guardar configuración
        foreach ($_POST['config'] as $clave => $valor) {
            $query = "UPDATE configuracion_home SET valor = :valor WHERE clave = :clave";
            $stmt = $db->prepare($query);
            $stmt->bindParam(':valor', $valor);
            $stmt->bindParam(':clave', $clave);
            $stmt->execute();
        }
        
        // Guardar categorías destacadas
        if (isset($_POST['categorias_destacadas'])) {
            $cat_ids = implode(',', $_POST['categorias_destacadas']);
            $query = "UPDATE configuracion_home SET valor = :valor WHERE clave = 'categorias_destacadas'";
            $stmt = $db->prepare($query);
            $stmt->bindParam(':valor', $cat_ids);
            $stmt->execute();
        } else {
            $cat_ids = '';
            $query = "UPDATE configuracion_home SET valor = :valor WHERE clave = 'categorias_destacadas'";
            $stmt = $db->prepare($query);
            $stmt->bindParam(':valor', $cat_ids);
            $stmt->execute();
        }
        
        // Redireccionar para refrescar datos
        header('Location: editor_home.php?updated=1');
        exit;
    }
}

$updated = isset($_GET['updated']) && $_GET['updated'] == 1;
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Editor Visual de Página Principal</h1>
        <a href="index.php" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
    </div>
    
    <?php if ($updated): ?>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            Configuración actualizada correctamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php endif; ?>
    
    <div class="row">
        <!-- Panel de control lateral -->
        <div class="col-md-3">
            <div class="card shadow mb-4 sticky-top" style="top: 20px;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Panel de Control</h6>
                </div>
                <div class="card-body">
                    <form id="editor-config-form" action="editor_home.php" method="POST">
                        <input type="hidden" name="action" value="save_config">
                        
                        <!-- Secciones visibles -->
                        <div class="mb-4">
                            <h6 class="font-weight-bold mb-3">Secciones Visibles</h6>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_slider" 
                                       name="config[mostrar_slider]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_slider']) || $configuraciones['mostrar_slider'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-slider">
                                <label class="form-check-label" for="mostrar_slider">
                                    Slider Principal
                                </label>
                                <a href="sliders/" class="ms-2 small">Editar sliders</a>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_categorias" 
                                       name="config[mostrar_categorias]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_categorias']) || $configuraciones['mostrar_categorias'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-categorias">
                                <label class="form-check-label" for="mostrar_categorias">
                                    Categorías Destacadas
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_banners" 
                                       name="config[mostrar_banners]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_banners']) || $configuraciones['mostrar_banners'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-banners">
                                <label class="form-check-label" for="mostrar_banners">
                                    Banners Promocionales
                                </label>
                                <a href="banners/" class="ms-2 small">Editar banners</a>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_destacados" 
                                       name="config[mostrar_destacados]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_destacados']) || $configuraciones['mostrar_destacados'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-destacados">
                                <label class="form-check-label" for="mostrar_destacados">
                                    Productos Destacados
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_nuevos" 
                                       name="config[mostrar_nuevos]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_nuevos']) || $configuraciones['mostrar_nuevos'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-nuevos">
                                <label class="form-check-label" for="mostrar_nuevos">
                                    Productos Nuevos
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_servicios" 
                                       name="config[mostrar_servicios]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_servicios']) || $configuraciones['mostrar_servicios'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-servicios">
                                <label class="form-check-label" for="mostrar_servicios">
                                    Servicios
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input section-toggle" type="checkbox" id="mostrar_marcas" 
                                       name="config[mostrar_marcas]" value="1" 
                                       <?php echo (!isset($configuraciones['mostrar_marcas']) || $configuraciones['mostrar_marcas'] == 1) ? 'checked' : ''; ?>
                                       data-target="#preview-marcas">
                                <label class="form-check-label" for="mostrar_marcas">
                                    Marcas Destacadas
                                </label>
                            </div>
                        </div>
                        
                        <!-- Configuraciones adicionales -->
                        <div class="mb-4">
                            <h6 class="font-weight-bold mb-3">Configuraciones</h6>
                            
                            <div class="mb-3">
                                <label for="productos_destacados_cantidad" class="form-label">Cantidad de productos destacados</label>
                                <input type="number" class="form-control" id="productos_destacados_cantidad" 
                                       name="config[productos_destacados_cantidad]" min="4" max="12" step="4" 
                                       value="<?php echo $configuraciones['productos_destacados_cantidad'] ?? 8; ?>">
                            </div>
                            
                            <div class="mb-3">
                                <label for="productos_nuevos_cantidad" class="form-label">Cantidad de productos nuevos</label>
                                <input type="number" class="form-control" id="productos_nuevos_cantidad" 
                                       name="config[productos_nuevos_cantidad]" min="4" max="12" step="4" 
                                       value="<?php echo $configuraciones['productos_nuevos_cantidad'] ?? 4; ?>">
                            </div>
                        </div>
                        
                        <!-- Categorías destacadas -->
                        <div class="mb-4">
                            <h6 class="font-weight-bold mb-3">Categorías Destacadas</h6>
                            <div class="border p-3" style="max-height: 200px; overflow-y: auto;">
                                <?php foreach ($categorias as $categoria): ?>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" 
                                               id="cat_<?php echo $categoria['id']; ?>" 
                                               name="categorias_destacadas[]" 
                                               value="<?php echo $categoria['id']; ?>"
                                               <?php echo in_array($categoria['id'], $categorias_destacadas_ids) ? 'checked' : ''; ?>>
                                        <label class="form-check-label" for="cat_<?php echo $categoria['id']; ?>">
                                            <?php echo $categoria['nombre']; ?>
                                        </label>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Vista previa -->
        <div class="col-md-9">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Vista Previa</h6>
                </div>
                <div class="card-body p-0">
                    <div class="preview-container">
                        <!-- Barra de navegación simulada -->
                        <div class="preview-navbar py-2 px-3 bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>CompuYA</strong>
                                </div>
                                <div>
                                    <small>Vista previa (los enlaces están desactivados)</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slider principal -->
                        <div id="preview-slider" class="preview-section <?php echo (!isset($configuraciones['mostrar_slider']) || $configuraciones['mostrar_slider'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Slider Principal</h6>
                                <a href="sliders/" class="preview-section-edit">Editar sliders</a>
                            </div>
                            
                            <?php if (count($sliders) > 0): ?>
                                <div class="preview-slider">
                                    <img src="<?php echo !empty($sliders[0]['imagen']) ? '../assets/uploads/sliders/' . $sliders[0]['imagen'] : '../assets/img/placeholder.png'; ?>" 
                                         class="img-fluid w-100" style="max-height: 300px; object-fit: cover;" alt="Slider">
                                    <div class="preview-slider-caption">
                                        <?php if (!empty($sliders[0]['titulo'])): ?>
                                            <h5><?php echo $sliders[0]['titulo']; ?></h5>
                                        <?php endif; ?>
                                        <?php if (!empty($sliders[0]['subtitulo'])): ?>
                                            <p><?php echo $sliders[0]['subtitulo']; ?></p>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            <?php else: ?>
                                <div class="preview-placeholder">
                                    <div class="text-center py-5 bg-light">
                                        <i class="fas fa-images fa-3x mb-3 text-muted"></i>
                                        <p>No hay sliders disponibles. <a href="sliders/crear.php">Añadir slider</a></p>
                                    </div>
                                </div>
                            <?php endif; ?>
                        </div>
                        
                        <!-- Categorías destacadas -->
                        <div id="preview-categorias" class="preview-section <?php echo (!isset($configuraciones['mostrar_categorias']) || $configuraciones['mostrar_categorias'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Categorías Destacadas</h6>
                                <button type="button" class="preview-section-edit" data-bs-toggle="modal" data-bs-target="#categoriasModal">
                                    Configurar categorías
                                </button>
                            </div>
                            
                            <div class="container py-3">
                                <h4 class="text-center mb-3">Categorías Destacadas</h4>
                                <div class="row">
                                    <?php
                                    $categorias_mostradas = [];
                                    foreach ($categorias_destacadas_ids as $cat_id) {
                                        foreach ($categorias as $categoria) {
                                            if ($categoria['id'] == $cat_id) {
                                                $categorias_mostradas[] = $categoria;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (count($categorias_mostradas) > 0):
                                        foreach ($categorias_mostradas as $categoria):
                                    ?>
                                        <div class="col-md-4 mb-3">
                                            <div class="card preview-category">
                                                <div class="card-body text-center">
                                                    <h5><?php echo $categoria['nombre']; ?></h5>
                                                </div>
                                            </div>
                                        </div>
                                    <?php
                                        endforeach;
                                    else:
                                    ?>
                                        <div class="col-12">
                                            <div class="preview-placeholder">
                                                <div class="text-center py-3 bg-light">
                                                    <p>No hay categorías destacadas seleccionadas.</p>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Banners -->
                        <div id="preview-banners" class="preview-section <?php echo (!isset($configuraciones['mostrar_banners']) || $configuraciones['mostrar_banners'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Banners Promocionales</h6>
                                <a href="banners/" class="preview-section-edit">Editar banners</a>
                            </div>
                            
                            <?php if (count($banners) > 0): ?>
                                <div class="container py-3">
                                    <div class="preview-banner">
                                        <img src="<?php echo !empty($banners[0]['imagen']) ? '../assets/uploads/banners/' . $banners[0]['imagen'] : '../assets/img/placeholder.png'; ?>" 
                                             class="img-fluid w-100" style="max-height: 200px; object-fit: cover;" alt="Banner">
                                        <div class="preview-banner-caption">
                                            <?php if (!empty($banners[0]['titulo'])): ?>
                                                <h5><?php echo $banners[0]['titulo']; ?></h5>
                                            <?php endif; ?>
                                            <?php if (!empty($banners[0]['subtitulo'])): ?>
                                                <p><?php echo $banners[0]['subtitulo']; ?></p>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                </div>
                            <?php else: ?>
                                <div class="preview-placeholder">
                                    <div class="text-center py-3 bg-light">
                                        <p>No hay banners disponibles. <a href="banners/crear.php">Añadir banner</a></p>
                                    </div>
                                </div>
                            <?php endif; ?>
                        </div>
                        
                        <!-- Productos Destacados -->
                        <div id="preview-destacados" class="preview-section <?php echo (!isset($configuraciones['mostrar_destacados']) || $configuraciones['mostrar_destacados'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Productos Destacados</h6>
                                <a href="productos/" class="preview-section-edit">Administrar productos</a>
                            </div>
                            
                            <div class="container py-3">
                                <h4 class="text-center mb-3">Productos Destacados</h4>
                                <div class="row">
                                    <?php if (count($productos_destacados) > 0): ?>
                                        <?php foreach (array_slice($productos_destacados, 0, 4) as $producto): ?>
                                            <div class="col-md-3 mb-3">
                                                <div class="card preview-product">
                                                    <div class="card-img-top bg-light" style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                                        <?php if (!empty($producto['imagen_principal'])): ?>
                                                            <img src="<?php echo '../assets/uploads/productos/' . $producto['imagen_principal']; ?>" 
                                                                 style="max-height: 100px; max-width: 100%;" alt="<?php echo $producto['nombre']; ?>">
                                                        <?php else: ?>
                                                            <i class="fas fa-box fa-3x text-muted"></i>
                                                        <?php endif; ?>
                                                    </div>
                                                    <div class="card-body">
                                                        <h6 class="card-title"><?php echo $producto['nombre']; ?></h6>
                                                        <p class="card-text text-primary">S/ <?php echo number_format($producto['precio'], 2); ?></p>
                                                    </div>
                                                </div>
                                            </div>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <div class="col-12">
                                            <div class="preview-placeholder">
                                                <div class="text-center py-3 bg-light">
                                                    <p>No hay productos destacados. <a href="productos/">Marcar productos como destacados</a></p>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos Nuevos -->
                        <div id="preview-nuevos" class="preview-section <?php echo (!isset($configuraciones['mostrar_nuevos']) || $configuraciones['mostrar_nuevos'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Productos Nuevos</h6>
                                <a href="productos/" class="preview-section-edit">Administrar productos</a>
                            </div>
                            
                            <div class="container py-3">
                                <h4 class="text-center mb-3">Productos Nuevos</h4>
                                <div class="row">
                                    <?php
                                    $query = "SELECT p.*, c.nombre as categoria_nombre 
                                              FROM productos p
                                              LEFT JOIN categorias c ON p.categoria_id = c.id
                                              WHERE p.nuevo = true AND p.activo = true
                                              ORDER BY p.id DESC LIMIT 4";
                                    $stmt = $db->prepare($query);
                                    $stmt->execute();
                                    $productos_nuevos = $stmt->fetchAll(PDO::FETCH_ASSOC);
                                    
                                    if (count($productos_nuevos) > 0):
                                        foreach ($productos_nuevos as $producto):
                                    ?>
                                        <div class="col-md-3 mb-3">
                                            <div class="card preview-product">
                                                <div class="card-img-top bg-light" style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                                    <?php if (!empty($producto['imagen_principal'])): ?>
                                                        <img src="<?php echo '../assets/uploads/productos/' . $producto['imagen_principal']; ?>" 
                                                             style="max-height: 100px; max-width: 100%;" alt="<?php echo $producto['nombre']; ?>">
                                                    <?php else: ?>
                                                        <i class="fas fa-box fa-3x text-muted"></i>
                                                    <?php endif; ?>
                                                </div>
                                                <div class="card-body">
                                                    <h6 class="card-title"><?php echo $producto['nombre']; ?></h6>
                                                    <p class="card-text text-primary">S/ <?php echo number_format($producto['precio'], 2); ?></p>
                                                </div>
                                            </div>
                                        </div>
                                    <?php
                                        endforeach;
                                    else:
                                    ?>
                                        <div class="col-12">
                                            <div class="preview-placeholder">
                                                <div class="text-center py-3 bg-light">
                                                    <p>No hay productos nuevos. <a href="productos/">Marcar productos como nuevos</a></p>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Servicios -->
                        <div id="preview-servicios" class="preview-section <?php echo (!isset($configuraciones['mostrar_servicios']) || $configuraciones['mostrar_servicios'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Servicios</h6>
                            </div>
                            
                            <div class="container py-3">
                                <h4 class="text-center mb-3">Nuestros Servicios</h4>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="card text-center preview-service">
                                            <div class="card-body">
                                                <i class="fas fa-truck fa-3x mb-3 text-primary"></i>
                                                <h5>Envío Rápido</h5>
                                                <p class="mb-0">Entregas en Lima en 24 horas</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card text-center preview-service">
                                            <div class="card-body">
                                                <i class="fas fa-headset fa-3x mb-3 text-primary"></i>
                                                <h5>Soporte Técnico</h5>
                                                <p class="mb-0">Asesoría especializada</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card text-center preview-service">
                                            <div class="card-body">
                                                <i class="fas fa-shield-alt fa-3x mb-3 text-primary"></i>
                                                <h5>Garantía Segura</h5>
                                                <p class="mb-0">Productos con garantía oficial</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Marcas -->
                        <div id="preview-marcas" class="preview-section <?php echo (!isset($configuraciones['mostrar_marcas']) || $configuraciones['mostrar_marcas'] == 1) ? '' : 'd-none'; ?>">
                            <div class="preview-section-header">
                                <h6 class="preview-section-title">Marcas Destacadas</h6>
                            </div>
                            
                            <div class="container py-3">
                                <h4 class="text-center mb-3">Marcas Destacadas</h4>
                                <div class="row align-items-center justify-content-center text-center">
                                    <div class="col-4 col-md-2 mb-3">
                                        <div class="p-2 bg-light">Logo 1</div>
                                    </div>
                                    <div class="col-4 col-md-2 mb-3">
                                        <div class="p-2 bg-light">Logo 2</div>
                                    </div>
                                    <div class="col-4 col-md-2 mb-3">
                                        <div class="p-2 bg-light">Logo 3</div>
                                    </div>
                                    <div class="col-4 col-md-2 mb-3">
                                        <div class="p-2 bg-light">Logo 4</div>
                                    </div>
                                    <div class="col-4 col-md-2 mb-3">
                                        <div class="p-2 bg-light">Logo 5</div>
                                    </div>
                                    <div class="col-4 col-md-2 mb-3">
                                        <div class="p-2 bg-light">Logo 6</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para configurar categorías destacadas -->
<div class="modal fade" id="categoriasModal" tabindex="-1" aria-labelledby="categoriasModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoriasModalLabel">Configurar Categorías Destacadas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Selecciona las categorías que quieres destacar en la página principal:</p>
                <div style="max-height: 300px; overflow-y: auto;">
                    <?php foreach ($categorias as $categoria): ?>
                        <div class="form-check mb-2">
                            <input class="form-check-input modal-categoria-check" type="checkbox" 
                                   id="modal_cat_<?php echo $categoria['id']; ?>" 
                                   value="<?php echo $categoria['id']; ?>"
                                   <?php echo in_array($categoria['id'], $categorias_destacadas_ids) ? 'checked' : ''; ?>>
                            <label class="form-check-label" for="modal_cat_<?php echo $categoria['id']; ?>